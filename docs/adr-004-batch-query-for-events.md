# ADR 4 — イベント取得のバッチクエリ化

- **ステータス**: 採用
- **コンテキスト**: `TodoItemGateway.GetAll()` では、まず全アイテムを取得した後、各アイテムの ID ごとに `GetEvents` を呼び出してイベント履歴を取得していた。`GetEvents` 内部では `item_created` / `item_started` / `item_completed` の 3 テーブルへ並列クエリを発行するため、N 件のアイテムがあると `1 + 3N` 回の DB アクセスが発生する（N+1 問題）。データ量が増えた場合にコネクションプール枯渇や DB 負荷増大のリスクがあった。
- **決定**: `PostgresDriver` に `GetAllEvents(IEnumerable<Guid> ids)` を追加し、3 テーブルを `UNION ALL` で結合した 1 クエリで全イベントを取得する。`TodoItemGateway.GetAll()` は、アイテム取得後にこのバッチメソッドを呼び、メモリ上で `TodoItemId` ごとにグルーピングして `TodoItem` を組み立てる。クエリ数は `1 + 3N` から `2` に削減される。
- **却下した案**:
  - `todo.items` と各イベントテーブルを JOIN する方式 → アイテム情報が行数分だけ重複して転送されるためデータ量が増える。また、イベントの種別判定ロジックが SQL 側に漏れ出し、ドメインロジックの流出につながるため却下。
  - `SemaphoreSlim` で同時実行数を制限する方式 → クエリ数自体は減らず根本解決にならない。コネクション制御の複雑さが増すため却下。
- **結果**: DB へのラウンドトリップが大幅に減り、スケーラビリティが向上する。グルーピング処理は Gateway 層に閉じており、Usecase やドメインへの影響はない。将来的にイベントテーブルが増えた場合も `UNION ALL` に追加するだけで対応できる。

